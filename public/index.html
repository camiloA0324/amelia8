<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Amelia - Sistema de Contabilidad para gesti√≥n de inventarios, ventas y reportes">
    <meta name="theme-color" content="#667eea">
    <title>Amelia - Sistema de Contabilidad</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        
        .login-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.warning {
            background: #ffc107;
            color: #333;
        }
        
        .user-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            color: #6c757d;
            min-width: 120px;
            text-align: center;
        }
        
        .nav-tab.active {
            background: #667eea;
            color: white;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        .stat-card p {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f8f9fa;
        }
        
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        /* Estilos para PWA - Responsive */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
                border-radius: 15px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .nav-tabs {
                overflow-x: auto;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .nav-tabs::-webkit-scrollbar {
                display: none;
            }
            
            .nav-tab {
                min-width: 100px;
                font-size: 14px;
                padding: 12px 15px;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .btn-small {
                padding: 5px 10px;
                font-size: 11px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .login-form {
                padding: 30px 20px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                margin: 5px;
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card h3 {
                font-size: 1rem;
            }
            
            .stat-card p {
                font-size: 1.5rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .login-form {
                padding: 20px 15px;
            }
        }
        
        /* Estilos para modo instalado */
        @media (display-mode: standalone) {
            body {
                padding-top: 10px;
            }
        }
    </style>
</head>
<body>
    
    <div class="container">
        <h1 id="appTitle">üìä Amelia - Iniciar Sesi√≥n</h1>
        
        <!-- Login Screen -->
        <div id="loginScreen" class="tab-content active">
            <div class="login-form">
                <h2 style="text-align: center; margin-bottom: 30px;">üîê Iniciar Sesi√≥n</h2>
                
                <div class="form-group">
                    <label>Usuario:</label>
                    <input type="text" id="username" placeholder="Ingrese su usuario">
                </div>
                <div class="form-group">
                    <label>Contrase√±a:</label>
                    <input type="password" id="password" placeholder="Ingrese su contrase√±a">
                </div>
                <button class="btn btn-primary" onclick="login()" style="width: 100%;">Iniciar Sesi√≥n</button>
            </div>
        </div>
        
        <!-- Main System -->
        <div id="mainSystem" class="tab-content">
            <div class="user-info">
                <h3 id="userWelcome">Bienvenido</h3>
                <p id="userRole">Rol: Usuario</p>
                <p id="userEmail">Email: usuario@amelia.com</p>
            </div>
            
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('products')">üì¶ Inventario</button>
                <button class="nav-tab" onclick="showTab('sales')">üí∞ Ventas</button>
                <button class="nav-tab" onclick="showTab('reports')">üìä Reportes</button>
                <button class="nav-tab" id="usersTab" onclick="showTab('users')" style="display:none;">üë• Usuarios</button>
                <button class="nav-tab" onclick="logout()">üö™ Salir</button>
            </div>
            
            <!-- Products Tab -->
            <div id="products" class="tab-content active">
                <h2>üì¶ Gesti√≥n de Inventario</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Referencia del Zapato:</label>
                        <input type="text" id="productCode" placeholder="Ej: AIR-MAX-001">
                    </div>
                    <div class="form-group">
                        <label>Nombre del Zapato:</label>
                        <input type="text" id="productName" placeholder="Ej: Nike Air Max">
                    </div>
                    <div class="form-group">
                        <label>Stock Inicial por Talla:</label>
                        <div id="sizesContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            <!-- Las tallas se generar√°n din√°micamente -->
                        </div>
                        <small style="color: #6c757d; margin-top: 5px; display: block;">Seleccione las tallas disponibles e indique la cantidad inicial de cada una</small>
                    </div>
                    <div class="form-group">
                        <label>Color:</label>
                        <input type="text" id="productColor" placeholder="Ej: Negro">
                    </div>
                    <div class="form-group">
                        <label>Precio de Compra:</label>
                        <input type="number" id="buyPrice" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Precio de Venta:</label>
                        <input type="number" id="sellPrice" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Stock M√≠nimo:</label>
                        <input type="number" id="minStock" placeholder="5" min="0" value="5">
                        <small style="color: #6c757d;">Alerta cuando el stock total est√© por debajo de este n√∫mero</small>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <button class="btn btn-success" onclick="addProduct()">‚ûï Agregar Producto</button>
                    <button class="btn btn-primary" onclick="clearProductForm()">üßπ Limpiar</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>üí∞ Ventas Totales</h3>
                        <p id="totalSalesAmount">$0</p>
                    </div>
                    <div class="stat-card">
                        <h3>üì¶ Productos</h3>
                        <p id="totalProducts">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>üìà Ganancia Neta</h3>
                        <p id="netProfit">$0</p>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Referencia</th>
                            <th>Nombre</th>
                            <th>Color</th>
                            <th>Total Pares</th>
                            <th>Tallas Disponibles</th>
                            <th>Precio Compra</th>
                            <th>Precio Venta</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="productsBody">
                    </tbody>
                </table>
            </div>
            
            <!-- Sales Tab -->
            <div id="sales" class="tab-content">
                <h2>üí∞ Registro de Ventas</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Producto:</label>
                        <select id="saleProduct">
                            <option value="">Seleccionar producto...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cantidad:</label>
                        <input type="number" id="saleQuantity" placeholder="1" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label>Cliente:</label>
                        <input type="text" id="saleCustomer" placeholder="Nombre del cliente">
                    </div>
                    <div class="form-group">
                        <label>M√©todo de Pago:</label>
                        <select id="paymentMethod">
                            <option value="efectivo">Efectivo</option>
                            <option value="tarjeta">Tarjeta</option>
                            <option value="transferencia">Transferencia</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <button class="btn btn-success" onclick="addSale()">üí∞ Registrar Venta</button>
                    <button class="btn btn-primary" onclick="clearSaleForm()">üßπ Limpiar</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Producto</th>
                            <th>Cliente</th>
                            <th>Cantidad</th>
                            <th>Total</th>
                            <th>M√©todo Pago</th>
                        </tr>
                    </thead>
                    <tbody id="salesBody">
                    </tbody>
                </table>
            </div>
            
            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <h2>üìä Reportes y An√°lisis</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>üìà Ventas del Mes</h3>
                        <p id="monthSales">$0</p>
                    </div>
                    <div class="stat-card">
                        <h3>üì¶ Productos Vendidos</h3>
                        <p id="productsSold">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>üí∞ Ganancia Total</h3>
                        <p id="totalProfit">$0</p>
                    </div>
                </div>
                
                <h3>üìã Resumen de Ventas</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad Vendida</th>
                            <th>Ingresos</th>
                        </tr>
                    </thead>
                    <tbody id="reportsBody">
                    </tbody>
                </table>
            </div>
            
            <!-- Users Tab -->
            <div id="users" class="tab-content">
                <h2>üë• Gesti√≥n de Usuarios</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre Completo:</label>
                        <input type="text" id="userName" placeholder="Nombre completo del usuario">
                    </div>
                    <div class="form-group">
                        <label>Usuario:</label>
                        <input type="text" id="userUsername" placeholder="Nombre de usuario">
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="userEmail" placeholder="correo@ejemplo.com">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a:</label>
                        <input type="password" id="userPassword" placeholder="Contrase√±a">
                    </div>
                    <div class="form-group">
                        <label>Tipo de Usuario:</label>
                        <select id="userType">
                            <option value="business_owner">Due√±o de Negocio</option>
                            <option value="seller">Vendedor</option>
                        </select>
                    </div>
                    <div class="form-group" id="businessOwnerFields">
                        <label>Nombre del Negocio:</label>
                        <input type="text" id="userBusiness" placeholder="Nombre del negocio">
                    </div>
                    <div class="form-group" id="sellerFields" style="display: none;">
                        <label>Negocio al que pertenece:</label>
                        <select id="parentBusiness">
                            <option value="">Seleccionar negocio...</option>
                        </select>
                    </div>
                    <div class="form-group" id="editUserFields" style="display: none;">
                        <label>Usuario a editar:</label>
                        <select id="editUserSelect">
                            <option value="">Seleccionar usuario...</option>
                        </select>
                        <button type="button" class="btn btn-warning btn-small" onclick="loadUserForEdit()" style="margin-top: 10px;">üìù Cargar datos</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <button class="btn btn-success" onclick="addUser()">üë§ Crear Usuario</button>
                    <button class="btn btn-warning" onclick="toggleEditMode()" id="editModeBtn">‚úèÔ∏è Modo Editar</button>
                    <button class="btn btn-primary" onclick="clearUserForm()">üßπ Limpiar</button>
                </div>
                
                <h3>üìã Usuarios Registrados</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Usuario</th>
                            <th>Email</th>
                            <th>Tipo</th>
                            <th>Negocio</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        var currentUser = null;
        var products = [];
        var sales = [];
        var users = [];
        var editMode = false;
        var editingUserId = null;
        
        // Funci√≥n para manejo seguro de localStorage
        function safeLocalStorage() {
            try {
                if (typeof Storage !== 'undefined' && window.localStorage) {
                    return {
                        getItem: function(key) {
                            try {
                                return localStorage.getItem(key);
                            } catch (e) {
                                return null;
                            }
                        },
                        setItem: function(key, value) {
                            try {
                                localStorage.setItem(key, value);
                            } catch (e) {
                                console.warn('Error guardando en localStorage:', e);
                            }
                        }
                    };
                }
            } catch (e) {
                console.warn('localStorage no disponible');
            }
            
            // Fallback para cuando localStorage no est√° disponible
            var tempStorage = {};
            return {
                getItem: function(key) {
                    return tempStorage[key] || null;
                },
                setItem: function(key, value) {
                    tempStorage[key] = value;
                }
            };
        }
        
        var storage = safeLocalStorage();
        
        // Inicializar datos
        function initializeData() {
            try {
                products = JSON.parse(storage.getItem('products') || '[]');
                sales = JSON.parse(storage.getItem('sales') || '[]');
                users = JSON.parse(storage.getItem('users') || '[]');
            } catch (e) {
                console.warn('Error cargando datos:', e);
                products = [];
                sales = [];
                users = [];
            }
            
            initializeDefaultAdmin();
        }
        
        // Forzar datos correctos del administrador principal
        function initializeDefaultAdmin() {
            var defaultAdmin = {
                id: 1,
                username: "camilo0324",
                password: "Amelia123",
                userType: "main_admin",
                name: "Camilo - Administrador Principal",
                email: "camilo@amelia.com",
                isMainAdmin: true,
                business: "Sistema Principal",
                isActive: true
            };
            
            var adminExists = users.find(function(u) { return u.username === 'camilo0324'; });
            
            if (!adminExists) {
                users.unshift(defaultAdmin);
                storage.setItem('users', JSON.stringify(users));
            } else {
                adminExists.isMainAdmin = true;
                adminExists.userType = "main_admin";
                storage.setItem('users', JSON.stringify(users));
            }
        }
        
        // Generar tallas din√°micamente con stock
        function generateSizesSelector() {
            var container = document.getElementById('sizesContainer');
            if (!container) return;
            
            container.innerHTML = '';
            container.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;';
            
            for (var i = 36; i <= 45; i++) {
                var sizeBox = document.createElement('div');
                sizeBox.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa;';
                
                sizeBox.innerHTML = 
                    '<input type="checkbox" id="size_' + i + '" value="' + i + '" onchange="toggleSizeStock(' + i + ')">' +
                    '<label for="size_' + i + '" style="cursor: pointer; margin: 0; font-weight: 600; min-width: 40px;">Talla ' + i + ':</label>' +
                    '<input type="number" id="stock_' + i + '" placeholder="Stock" min="0" value="0" style="width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;" disabled>';
                
                container.appendChild(sizeBox);
            }
        }
        
        function toggleSizeStock(size) {
            var checkbox = document.getElementById('size_' + size);
            var stockInput = document.getElementById('stock_' + size);
            
            if (checkbox && stockInput) {
                stockInput.disabled = !checkbox.checked;
                if (!checkbox.checked) {
                    stockInput.value = '0';
                } else {
                    stockInput.focus();
                }
            }
        }
        
        // Funciones de utilidad
        function showNotification(message, type) {
            var notification = document.createElement('div');
            notification.className = 'notification ' + (type || 'success');
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(function() { 
                if (notification.parentNode) {
                    document.body.removeChild(notification); 
                }
            }, 3000);
        }

        function formatCurrency(amount) {
            return '$' + (amount || 0).toFixed(2);
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('es-ES');
        }

        // Funciones de autenticaci√≥n
        function login() {
            var usernameElement = document.getElementById('username');
            var passwordElement = document.getElementById('password');
            
            if (!usernameElement || !passwordElement) {
                showNotification('Error: Elementos de login no encontrados', 'error');
                return;
            }
            
            var username = usernameElement.value.trim();
            var password = passwordElement.value;
            
            if (!username || !password) {
                showNotification('Por favor ingrese usuario y contrase√±a', 'error');
                return;
            }
            
            var user = users.find(function(u) {
                return u.username.toLowerCase() === username.toLowerCase() && u.password === password;
            });
            
            if (user) {
                currentUser = user;
                
                var loginScreen = document.getElementById('loginScreen');
                var mainSystem = document.getElementById('mainSystem');
                var appTitle = document.getElementById('appTitle');
                var userWelcome = document.getElementById('userWelcome');
                var userRole = document.getElementById('userRole');
                var userEmail = document.getElementById('userEmail');
                var usersTab = document.getElementById('usersTab');
                
                if (loginScreen) loginScreen.classList.remove('active');
                if (mainSystem) mainSystem.classList.add('active');
                if (appTitle) appTitle.textContent = 'üìä Amelia - Sistema de Contabilidad';
                if (userWelcome) userWelcome.textContent = 'Bienvenido, ' + user.name;
                
                var userTypeText = '';
                if (user.isMainAdmin === true) {
                    userTypeText = 'Administrador Principal';
                } else if (user.userType === 'business_owner') {
                    userTypeText = 'Due√±o de Negocio';
                } else if (user.userType === 'seller') {
                    userTypeText = 'Vendedor';
                } else {
                    userTypeText = 'Usuario';
                }
                
                if (userRole) userRole.textContent = 'Tipo: ' + userTypeText;
                if (userEmail) userEmail.textContent = 'Email: ' + user.email;
                
                if (usersTab && (user.isMainAdmin || user.userType === 'business_owner')) {
                    usersTab.style.display = 'block';
                }
                
                setTimeout(function() {
                    generateSizesSelector();
                    loadProducts();
                    loadSales();
                    updateDashboard();
                }, 100);
                
                showNotification('Bienvenido ' + user.name, 'success');
            } else {
                showNotification('Usuario o contrase√±a incorrectos', 'error');
            }
        }

        function logout() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                currentUser = null;
                document.getElementById('mainSystem').classList.remove('active');
                document.getElementById('loginScreen').classList.add('active');
                document.getElementById('appTitle').textContent = 'üìä Amelia - Iniciar Sesi√≥n';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('usersTab').style.display = 'none';
                showNotification('Sesi√≥n cerrada', 'warning');
            }
        }

        // Navegaci√≥n
        function showTab(tabId) {
            var tabs = document.querySelectorAll('.tab-content');
            var navTabs = document.querySelectorAll('.nav-tab');
            
            tabs.forEach(function(tab) {
                if (!tab.id.includes('Screen') && !tab.id.includes('System')) {
                    tab.classList.remove('active');
                }
            });
            
            navTabs.forEach(function(navTab) {
                navTab.classList.remove('active');
            });
            
            var activeTab = document.getElementById(tabId);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            if (window.event && window.event.target) {
                window.event.target.classList.add('active');
            }
            
            if (tabId === 'sales') {
                loadSaleProductOptions();
            } else if (tabId === 'reports') {
                loadReports();
            } else if (tabId === 'users') {
                loadUsers();
                toggleUserTypeFields();
            }
        }

        // Gesti√≥n de productos
        function addProduct() {
            var code = document.getElementById('productCode').value.trim();
            var name = document.getElementById('productName').value.trim();
            var color = document.getElementById('productColor').value.trim();
            var buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            var sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;
            var minStock = parseInt(document.getElementById('minStock').value) || 5;
            
            var selectedSizes = {};
            var hasSelectedSizes = false;
            
            for (var i = 36; i <= 45; i++) {
                var checkbox = document.getElementById('size_' + i);
                var stockInput = document.getElementById('stock_' + i);
                
                if (checkbox && checkbox.checked && stockInput) {
                    var stock = parseInt(stockInput.value) || 0;
                    selectedSizes[i] = stock;
                    hasSelectedSizes = true;
                }
            }
            
            if (!code || !name || !color || !hasSelectedSizes) {
                showNotification('Complete todos los campos y seleccione al menos una talla con stock', 'error');
                return;
            }
            
            if (sellPrice <= buyPrice) {
                showNotification('El precio de venta debe ser mayor al de compra', 'error');
                return;
            }
            
            var existingGroup = products.find(function(p) { 
                return p.code === code && p.color === color; 
            });
            
            if (existingGroup) {
                showNotification('Ya existe esta referencia con este color', 'error');
                return;
            }
            
            var productGroup = {
                id: Date.now(),
                code: code,
                name: name,
                color: color,
                buyPrice: buyPrice,
                sellPrice: sellPrice,
                minStock: minStock,
                sizes: selectedSizes,
                totalStock: 0
            };
            
            productGroup.totalStock = Object.values(selectedSizes).reduce(function(sum, stock) {
                return sum + stock;
            }, 0);
            
            products.push(productGroup);
            storage.setItem('products', JSON.stringify(products));
            loadProducts();
            clearProductForm();
            updateDashboard();
            showNotification('Producto agregado exitosamente con ' + productGroup.totalStock + ' pares', 'success');
        }

        function clearProductForm() {
            document.getElementById('productCode').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productColor').value = '';
            document.getElementById('buyPrice').value = '';
            document.getElementById('sellPrice').value = '';
            document.getElementById('minStock').value = '5';
            
            for (var i = 36; i <= 45; i++) {
                var checkbox = document.getElementById('size_' + i);
                var stockInput = document.getElementById('stock_' + i);
                
                if (checkbox) checkbox.checked = false;
                if (stockInput) {
                    stockInput.value = '0';
                    stockInput.disabled = true;
                }
            }
        }

        function loadProducts() {
            var tbody = document.getElementById('productsBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            products.forEach(function(product) {
                var row = document.createElement('tr');
                
                var totalStock = 0;
                var availableSizes = [];
                
                Object.keys(product.sizes || {}).forEach(function(size) {
                    var stock = product.sizes[size] || 0;
                    totalStock += stock;
                    if (stock > 0) {
                        availableSizes.push(size + '(' + stock + ')');
                    }
                });
                
                product.totalStock = totalStock;
                
                var stockStatus = totalStock <= product.minStock ? 
                    '<span style="color: #dc3545;">' + totalStock + ' ‚ö†Ô∏è</span>' : 
                    '<span style="color: #28a745;">' + totalStock + ' ‚úÖ</span>';
                
                var sizesDisplay = availableSizes.length > 0 ? availableSizes.join(', ') : 'Sin stock';
                
                var actions = '';
                if (currentUser && (currentUser.isMainAdmin || currentUser.userType === 'business_owner')) {
                    actions = '<button class="btn btn-primary btn-small" onclick="manageStock(' + product.id + ')">üì¶ Stock</button> ' +
                              '<button class="btn btn-danger btn-small" onclick="deleteProduct(' + product.id + ')">üóëÔ∏è</button>';
                } else if (currentUser) {
                    actions = '<button class="btn btn-primary btn-small" onclick="editSellPrice(' + product.id + ')">üí∞ Precio</button>';
                }
                
                row.innerHTML = 
                    '<td>' + product.code + '</td>' +
                    '<td>' + product.name + '</td>' +
                    '<td>' + product.color + '</td>' +
                    '<td>' + stockStatus + '</td>' +
                    '<td><small>' + sizesDisplay + '</small></td>' +
                    '<td>' + formatCurrency(product.buyPrice) + '</td>' +
                    '<td id="sellPrice_' + product.id + '">' + formatCurrency(product.sellPrice) + '</td>' +
                    '<td>' + actions + '</td>';
                tbody.appendChild(row);
            });
        }

        function manageStock(productId) {
            var product = products.find(function(p) { return p.id === productId; });
            if (!product) return;
            
            var stockModal = document.createElement('div');
            stockModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;';
            
            var modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;';
            
            var sizesHtml = '';
            Object.keys(product.sizes).forEach(function(size) {
                var currentStock = product.sizes[size] || 0;
                sizesHtml += '<div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">' +
                           '<label style="width: 60px;">Talla ' + size + ':</label>' +
                           '<input type="number" id="stock_' + size + '" value="' + currentStock + '" min="0" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 5px;">' +
                           '<span>pares</span></div>';
            });
            
            modalContent.innerHTML = 
                '<h3 style="margin-bottom: 20px;">üì¶ Gestionar Stock - ' + product.name + '</h3>' +
                '<p><strong>Referencia:</strong> ' + product.code + ' | <strong>Color:</strong> ' + product.color + '</p>' +
                '<div style="max-height: 300px; overflow-y: auto; margin: 20px 0;">' + sizesHtml + '</div>' +
                '<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">' +
                '<button onclick="updateStock(' + productId + ')" class="btn btn-success">üíæ Guardar</button>' +
                '<button onclick="closeStockModal()" class="btn btn-danger">‚ùå Cancelar</button>' +
                '</div>';
            
            stockModal.appendChild(modalContent);
            document.body.appendChild(stockModal);
            stockModal.id = 'stockModal';
        }

        function updateStock(productId) {
            var product = products.find(function(p) { return p.id === productId; });
            if (!product) return;
            
            Object.keys(product.sizes).forEach(function(size) {
                var input = document.getElementById('stock_' + size);
                if (input) {
                    product.sizes[size] = parseInt(input.value) || 0;
                }
            });
            
            storage.setItem('products', JSON.stringify(products));
            loadProducts();
            updateDashboard();
            closeStockModal();
            showNotification('Stock actualizado exitosamente', 'success');
        }

        function closeStockModal() {
            var modal = document.getElementById('stockModal');
            if (modal) {
                modal.remove();
            }
        }

        function editSellPrice(productId) {
            var product = products.find(function(p) { return p.id === productId; });
            if (!product) return;
            
            var newPrice = prompt('Nuevo precio de venta para: ' + product.name, product.sellPrice);
            if (newPrice === null) return;
            
            newPrice = parseFloat(newPrice);
            if (isNaN(newPrice) || newPrice <= 0) {
                showNotification('Precio inv√°lido', 'error');
                return;
            }
            
            if (newPrice <= product.buyPrice) {
                showNotification('El precio de venta debe ser mayor al precio de compra (' + formatCurrency(product.buyPrice) + ')', 'error');
                return;
            }
            
            product.sellPrice = newPrice;
            storage.setItem('products', JSON.stringify(products));
            
            var priceElement = document.getElementById('sellPrice_' + productId);
            if (priceElement) {
                priceElement.textContent = formatCurrency(newPrice);
            }
            
            showNotification('Precio actualizado exitosamente', 'success');
        }

        function deleteProduct(id) {
            if (confirm('¬øEliminar producto?')) {
                products = products.filter(function(p) { return p.id !== id; });
                storage.setItem('products', JSON.stringify(products));
                loadProducts();
                updateDashboard();
                showNotification('Producto eliminado', 'warning');
            }
        }

        // Gesti√≥n de ventas
        function loadSaleProductOptions() {
            var select = document.getElementById('saleProduct');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleccionar producto...</option>';
            
            products.filter(function(p) { return p.totalStock > 0; }).forEach(function(product) {
                var option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.code + ' - ' + product.name + ' (' + product.color + ') - Stock: ' + product.totalStock;
                select.appendChild(option);
            });
        }

        function addSale() {
            var productId = parseInt(document.getElementById('saleProduct').value);
            var quantity = parseInt(document.getElementById('saleQuantity').value) || 1;
            var customer = document.getElementById('saleCustomer').value.trim();
            var paymentMethod = document.getElementById('paymentMethod').value;
            
            if (!productId) {
                showNotification('Seleccione un producto', 'error');
                return;
            }
            
            var product = products.find(function(p) { return p.id === productId; });
            if (!product || product.totalStock < quantity) {
                showNotification('Stock insuficiente', 'error');
                return;
            }
            
            var sale = {
                id: Date.now(),
                productId: productId,
                productName: product.code + ' - ' + product.name + ' (' + product.color + ')',
                quantity: quantity,
                unitPrice: product.sellPrice,
                total: quantity * product.sellPrice,
                customer: customer || 'Cliente an√≥nimo',
                paymentMethod: paymentMethod,
                date: new Date().toISOString()
            };
            
            sales.push(sale);
            
            var remainingQuantity = quantity;
            Object.keys(product.sizes).forEach(function(size) {
                if (remainingQuantity > 0 && product.sizes[size] > 0) {
                    var reduction = Math.min(product.sizes[size], remainingQuantity);
                    product.sizes[size] -= reduction;
                    remainingQuantity -= reduction;
                }
            });
            
            storage.setItem('sales', JSON.stringify(sales));
            storage.setItem('products', JSON.stringify(products));
            
            loadSales();
            loadProducts();
            loadSaleProductOptions();
            clearSaleForm();
            updateDashboard();
            
            showNotification('Venta registrada exitosamente', 'success');
        }

        function clearSaleForm() {
            document.getElementById('saleProduct').value = '';
            document.getElementById('saleQuantity').value = '1';
            document.getElementById('saleCustomer').value = '';
            document.getElementById('paymentMethod').value = 'efectivo';
        }

        function loadSales() {
            var tbody = document.getElementById('salesBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            sales.slice().reverse().forEach(function(sale) {
                var row = document.createElement('tr');
                row.innerHTML = 
                    '<td>' + formatDate(sale.date) + '</td>' +
                    '<td>' + sale.productName + '</td>' +
                    '<td>' + sale.customer + '</td>' +
                    '<td>' + sale.quantity + '</td>' +
                    '<td>' + formatCurrency(sale.total) + '</td>' +
                    '<td>' + sale.paymentMethod + '</td>';
                tbody.appendChild(row);
            });
        }

        // Reportes
        function loadReports() {
            var salesByProduct = {};
            var totalSold = 0;
            
            sales.forEach(function(sale) {
                if (!salesByProduct[sale.productName]) {
                    salesByProduct[sale.productName] = { quantity: 0, revenue: 0 };
                }
                salesByProduct[sale.productName].quantity += sale.quantity;
                salesByProduct[sale.productName].revenue += sale.total;
                totalSold += sale.quantity;
            });
            
            var tbody = document.getElementById('reportsBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            Object.keys(salesByProduct).forEach(function(productName) {
                var data = salesByProduct[productName];
                var row = document.createElement('tr');
                row.innerHTML = 
                    '<td>' + productName + '</td>' +
                    '<td>' + data.quantity + '</td>' +
                    '<td>' + formatCurrency(data.revenue) + '</td>';
                tbody.appendChild(row);
            });
            
            var productsSoldElement = document.getElementById('productsSold');
            if (productsSoldElement) {
                productsSoldElement.textContent = totalSold;
            }
        }

        // Gesti√≥n de usuarios (simplificada)
        function addUser() {
            showNotification('Funcionalidad de usuarios disponible pr√≥ximamente', 'warning');
        }

        function toggleUserTypeFields() {
            // Funci√≥n simplificada para evitar errores
        }

        function loadUsers() {
            var tbody = document.getElementById('usersBody');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6c757d;">Gesti√≥n de usuarios disponible pr√≥ximamente</td></tr>';
        }

        // Dashboard
        function updateDashboard() {
            var totalSalesAmountElement = document.getElementById('totalSalesAmount');
            var totalProductsElement = document.getElementById('totalProducts');
            var netProfitElement = document.getElementById('netProfit');
            var monthSalesElement = document.getElementById('monthSales');
            var totalProfitElement = document.getElementById('totalProfit');
            
            var totalSalesAmount = sales.reduce(function(sum, sale) { return sum + sale.total; }, 0);
            var totalProducts = products.length;
            var totalCost = 0;
            var totalRevenue = 0;
            
            sales.forEach(function(sale) {
                var product = products.find(function(p) { return p.id === sale.productId; });
                if (product) {
                    totalCost += product.buyPrice * sale.quantity;
                    totalRevenue += sale.total;
                }
            });
            
            var netProfit = totalRevenue - totalCost;
            
            if (totalSalesAmountElement) totalSalesAmountElement.textContent = formatCurrency(totalSalesAmount);
            if (totalProductsElement) totalProductsElement.textContent = totalProducts;
            if (netProfitElement) netProfitElement.textContent = formatCurrency(netProfit);
            if (monthSalesElement) monthSalesElement.textContent = formatCurrency(totalSalesAmount);
            if (totalProfitElement) totalProfitElement.textContent = formatCurrency(netProfit);
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            
            var usernameInput = document.getElementById('username');
            var passwordInput = document.getElementById('password');
            
            if (usernameInput) {
                usernameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') login();
                });
            }
            
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') login();
                });
            }
            
            generateSizesSelector();
            
            console.log('Sistema Amelia cargado correctamente');
        });
    </script>
</body>
</html>
